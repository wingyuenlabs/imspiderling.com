---
Title: Create a Pull request into another repository using github actions.
Description: 
Author: Dimitrios Desyllas
Date: 2025-09-05T21:40:38.000Z
Robots: noindex,nofollow
Template: index
---
<p>Upon developing the <a href="https://github.com/pc-magas/mkdotenv" rel="noopener noreferrer">mkdotenv</a> project I hgad this partucilar problem. I needed to release upon mac as well and for that I need a repo that hosts the homebrew <a href="https://github.com/pc-magas/homebrew-mkdotenv" rel="noopener noreferrer">tap</a>. </p>

<p>The procedure I developed is the following:</p>

<ol>
<li>Upon mkdotenv actions create the homebrew tap</li>
<li>Clone homebrew repo</li>
<li>Create a branch and copy the file into <code>Formula</code> folder</li>
<li>Test that app is installed</li>
<li>push the branch</li>
<li>Create the PR</li>
</ol>

<p>The last steps was the one that caused me pain therefore I would explain what I did to solve it.</p>

<h2>
  
  
  Required apps and settings I needed to install
</h2>

<h3>
  
  
  Step1 Install Qoomon Access Tokens for GitHub Actions
</h3>

<p>I used the <a href="https://github.com/qoomon/actions--access-token" rel="noopener noreferrer">qoomon/actions--access-token</a> project, that provided me a GitHub App that can issue temporary tokens during a workflow run. These tokens are powerful because they can grant fine-grained permissions such as pushing branches or opening PRs across repositories â€” something the default GITHUB_TOKEN cannot always do. Also it is a better alternative than storing PAT upon secrets as well.</p>

<p>In my case I installed it from <a href="https://github.com/marketplace/access-manager-for-github-actions" rel="noopener noreferrer">Marketplace</a>. Setup is free, but since itâ€™s an app install, but I needed to go through the standard GitHub "purchase" flow (at $0), that required meto provide some basic private info (name and address mostly).</p>

<p>Once the app is installed, I had to define token policies using YAML files. There are two levels of configuration:</p>

<ol>
<li><p><strong>Global policies (.github-access-token repo)</strong><br>
You create a dedicated repository named .github-access-token.<br>
Inside it, you add an access-token.yaml file that defines the general rules: which repositories can request tokens, and what operations are allowed.<br>
Think of this as your organization-wide or user-wide "master policy".<br>
ðŸ‘‰ Example: my <a href="https://github.com/pc-magas/.github-access-token/blob/master/access-token.yaml" rel="noopener noreferrer">.github-access-token repo</a></p></li>
<li><p>Local policies (.github/access-token.yaml in a repo)<br>
Inside each target repo (the one you want to push to or create a PR against), you also create a file at .github/access-token.yaml.<br>
This file must match the owner of the global repo above and acts as a per-repository confirmation.<br>
It narrows down the rules from the global file to the specific repository, making sure you explicitly allow those actions in that repo.   </p></li>
</ol>

<p>In my case I have 3 repos:</p>

<ol>
<li>
<code>pc-magas/.github-access-token</code> in which I have the general policies of allowed action upon <code>access-token.yaml</code>  in it</li>
<li>
<code>pc-magas/homebrew-mkdotenv</code> The homebrew tap in which pr's would be autogenerated</li>
<li>
<code>pc-magas/mkdotenv</code> in which:

<ol>
<li>Formula file is created</li>
<li>Github action create and push a branch upon <code>pc-magas/homebrew-mkdotenv</code> with the new formula</li>
<li>A pr is created</li>
</ol>


</li>

</ol>

<p>As you notice all of them are owned by <code>pc-magas</code>.</p>

<p>The general flow goes as follows:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>+---------------------------+                  +-----------------------------+
|   pc-magas/mkdotenv       |                  |  pc-magas/homebrew-mkdotenv |
|  (creates formula)        |                  |  (receives PRs)             |
|                           |                  |                             |
|  GitHub Action runs ---&gt;  |  ----push----&gt;   |   Branch created            |
|                           |                  |   PR opened                 |
+---------------------------+                  +-----------------------------+
             |                                               ^
             |                                               |
             v                                               |
   +---------------------------+                             |
   | .github-access-token repo |                             |
   | (global policy)           |                             |
   |  access-token.yaml        |                             |
   +---------------------------+                             |
             |                                               |
             |  defines who can request tokens               |
             v                                               |
   +---------------------------+                             |
   | target repo config        |                             |
   | .github/access-token.yaml |-----------------------------+
   | (local policy)            |
   +---------------------------+
             |
             v
   Tokens issued at workflow runtime
   with correct permissions

</code></pre>

</div>



<h3>
  
  
  Step 2 configure generic policy upon <code>.github-access-token</code> repo.
</h3>

<p>As described above you need to create a repo named <code>.github-access-token</code>, on it I needed to create a file named <code>access-token.yaml</code>. <br>
In my case these are the settings I needed to place upon:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight yaml"><code>
<span class="na">origin</span><span class="pi">:</span> <span class="s">pc-magas/.github-access-token</span>


<span class="na">allowed-repository-permissions</span><span class="pi">:</span>
  <span class="na">actions</span><span class="pi">:</span> <span class="s">write</span> <span class="c1"># read or write</span>
  <span class="na">contents</span><span class="pi">:</span> <span class="s">write</span> <span class="c1"># read or write</span>
  <span class="na">pull-requests</span><span class="pi">:</span> <span class="s">write</span> <span class="c1"># read or write</span>

<span class="c1"># Grant owner scoped permissions (owner permission or owner wide repository permissions)</span>
<span class="c1"># NOTE: Every statement will always implicitly grant `metadata: read` permission.</span>
<span class="na">statements</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">subjects</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">repo:${origin}:ref:refs/heads/dev</span>
      <span class="pi">-</span> <span class="s">repo:${origin}:workflow_ref:${origin}/.github/workflows/release.yml@refs/heads/dev</span>
    <span class="na">permissions</span><span class="pi">:</span>
      <span class="na">pull-requests</span><span class="pi">:</span> <span class="s">write</span>
</code></pre>

</div>



<h4>
  
  
  1. origin
</h4>

<p>The origin field tells the app which .github-access-token repo defines the global policy.<br>
It always follows the format:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>OWNER/.github-access-token
</code></pre>

</div>



<ul>
<li>
<code>OWNER</code> = your GitHub username or organization name</li>
<li>
<code>.github-access-token</code> = the special repository that stores the global rules</li>
</ul>

<p>Examples:</p>

<ul>
<li><p>For my personal account (pc-magas), the repo is named <code>pc-magas/.github-access-token</code></p></li>
<li><p>If the owner was an organization named ellakcy, then it would be <code>ellakcy/.github-access-token</code></p></li>
</ul>

<p>This matters because when a workflow requests a token, the app checks:</p>

<ul>
<li>Which global policy repo (origin) it should look at</li>
<li>Whether that policy allows issuing the token for the requested action</li>
</ul>

<h4>
  
  
  2. <code>allowed-repository-permissions</code>
</h4>

<p>This section sets the maximum permissions a token can have when issued.<br>
Think of it as the "permission budget".<br>
For example:</p>

<ul>
<li>
<code>actions: write</code> â†’ allows running workflows</li>
<li>
<code>contents: write</code> â†’ allows pushing/pulling commits</li>
<li>
<code>pull-requests: write</code> â†’ allows creating or updating PRs</li>
</ul>

<p>There is an full <a href="https://github.com/qoomon/actions--access-token/blob/main/action/docs/access-token.owner-template.yaml" rel="noopener noreferrer">template</a> that can be used upon for reference.</p>
<h4>
  
  
  3. <code>statements</code>
</h4>

<p>This section defines who is allowed to request a token and what extra permissions they get.<br>
It works like an access control rule:</p>

<ul>
<li>
<code>subjects</code>: â†’ specifies which workflows or branches can ask for tokens</li>
<li>
<code>permissions</code>: â†’ specifies what those subjects are allowed to do</li>
</ul>

<p>Example from above:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>statements:
  - subjects:
      - repo:${origin}:ref:refs/heads/dev
      - repo:${origin}:workflow_ref:${origin}/.github/workflows/release.yml@refs/heads/dev
    permissions:
      pull-requests: write
</code></pre>

</div>



<p>This means:</p>

<ul>
<li>Only workflows running from the dev branch of the .github-access-token repo can request a token.</li>
<li>Those workflows are granted pull-requests: write permission (so they can open or update PRs).</li>
</ul>

<p>If you want to allow multiple repositories you need to add multiple sections and what permissions are allowed.</p>

<h3>
  
  
  Step 3 Define a local policy on repo you want to perform PR
</h3>

<p>The local policy lives inside the target repository â€” the repo where you want to push code or create a pull request.<br>
This policy acts as an explicit opt-in: it tells GitHub, "yes, I allow workflows from these repos/branches to perform actions here."</p>

<p>For my case, this file lives in <code>pc-magas/homebrew-mkdotenv</code> repo upon<code>.github/access-token.yaml</code> file:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>origin: pc-magas/homebrew-mkdotenv
statements:
  - subjects:
      - repo:pc-magas/mkdotenv:** # all refs, workflows, environments
    permissions:
      contents: write
      pull-requests: write
</code></pre>

</div>



<p>The first thing you notice is that this file is a more slimmed-down version of the global policy. Only origin and statements are present here. As before, the origin field simply points to the repository where this local policy file lives. Then, under the statements section, you describe which repositories are allowed to interact with this one and what they are allowed to do.</p>

<p>You can add one or more entries under statements. Each entry can target a different repository or workflow and specify the actions it may perform. The actual actions are defined in the permissions section.</p>

<p>In my case, I allow anything from pc-magas/mkdotenv â€” whether itâ€™s a branch, a workflow, or an environment â€” to push code and open pull requests into <code>pc-magas/homebrew-mkdotenv</code>.</p>

<h2>
  
  
  Implement Github action
</h2>

<p>A minimal example of my full <a href="https://raw.githubusercontent.com/pc-magas/mkdotenv/refs/heads/master/.github/workflows/release.yml" rel="noopener noreferrer">worflow</a> is shown below. <br>
Upon myrepo the pipeline has multiple jobs, but the one that matters for creating the pull request is <code>test_homebrew</code>.<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>
test_homebrew:
  runs-on: macos-latest
  permissions:
    contents: write
    id-token: write
  needs:
    - release
    - build_mac
  steps:

    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download homebrew formula for macos
      uses: actions/download-artifact@v4
      with:
        name: mkdotenv-macos-homebrew-formula
        path: ./macos/bin

    - name: Generate GitHub App token
      id: token
      uses: qoomon/actions--access-token@v3
      with:
        repository: pc-magas/homebrew-mkdotenv
        permissions: |
          contents: write
          pull_requests: write

    - name: setup git and clone brew formula
      env:
        GH_PAT: ${{ steps.token.outputs.token }}
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "actions@github.com"

        git clone https://x-access-token:${GH_PAT}@github.com/pc-magas/homebrew-mkdotenv.git
        cd homebrew-mkdotenv

        git checkout -b test-update-formula-${{ github.run_number }}

    - name: setup formula
      run: |
        cd homebrew-mkdotenv
        mkdir -p ./Formula
        cp ../macos/bin/mkdotenv.rb ./Formula/mkdotenv.rb

    - name: Create Pull Request to homebrew repo
      env:
        GH_PAT: ${{ steps.token.outputs.token }}
      run: |
        cd homebrew-mkdotenv

        BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
        git add ./Formula/mkdotenv.rb
        git commit -m "Update formula via GitHub Actions"
        git push origin ${BRANCH_NAME}

        VERSION=$(grep -E '^  version ' ./Formula/mkdotenv.rb | sed 's/.*"\(.*\)".*/\1/')

        curl --fail-with-body -vvv -X POST https://api.github.com/repos/pc-magas/homebrew-mkdotenv/pulls \
          -H "Authorization: Bearer $GH_PAT" \
          -H "Accept: application/vnd.github+json" \
          -H "Content-Type: application/json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          -d "{\"title\": \"Update formula [VERSION $VERSION]\",\"head\": \"$BRANCH_NAME\",\"base\": \"master\",\"body\": \"Automated update\"}"


</code></pre>

</div>



<p>The flow follows a simple philosophy:</p>

<ol>
<li>Clone the target repo</li>
<li>Create a new branch
3.Copy or modify the necessary files
4.Commit and push the changes
5.Open a pull request</li>
</ol>

<p>The key part is how authentication works. The GitHub App token is generated here:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>      - name: Generate GitHub App token
        id: token
        uses: qoomon/actions--access-token@v3
        with:
          repository: pc-magas/homebrew-mkdotenv
          permissions: |
            contents: write
            pull_requests: write
</code></pre>

</div>



<p>This uses the <code>qoomon/actions--access-token</code> action to issue a temporary token with just the right permissions. The token is then exposed as <code>teps.token.outputs.token</code> and passed into later steps through an environment variable called <code>GH_PAT</code> like this:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code> - name: setup git and clone brew formula
        env:
          GH_PAT: ${{ steps.token.outputs.token }}
        run: |
          # These are needed in order to config which does the push and PR
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"

          git clone https://x-access-token:${GH_PAT}@github.com/pc-magas/homebrew-mkdotenv.git
          cd homebrew-mkdotenv

          # Create new branch for PR
          git checkout -b test-update-formula-${{ github.run_number }}
</code></pre>

</div>



<p>When cloning the repo, authentication is set up by injecting that token into the HTTPS URL:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>git clone https://x-access-token:${GH_PAT}@github.com/pc-magas/homebrew-mkdotenv.git
</code></pre>

</div>



<p>Notice the x-access-token:${GH_PAT} part inside the repository URL. This is what enables Git to authenticate in a non-interactive way during the workflow, so the branch can be created and pushed automatically.</p>

<p>The PR itself is done using the <a href="https://docs.github.com/en/rest/pulls/pulls?apiVersion=2022-11-28#create-a-pull-request" rel="noopener noreferrer">Github rest api</a>, we use the very same key we used upon cloning. </p>

<p>For api consumption we need to use <code>curl</code>, the call is performed like this:<br>
</p>

<div class="highlight js-code-highlight">
<pre class="highlight plaintext"><code>          curl --fail-with-body -X POST https://api.github.com/repos/pc-magas/homebrew-mkdotenv/pulls \
            -H "Authorization: Bearer $GH_PAT" \
            -H "Accept: application/vnd.github+json" \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -d "{\"title\": \"Update formula [VERSION $VERSION]\",\"head\": \"$BRANCH_NAME\",\"base\": \"master\",\"body\": \"Automated update\"}"
</code></pre>

</div>



<p>The generated key is provided as bearer token. Also when using <code>curl</code> upon github actions it is nice to aplo place the <code>--fail-with-body</code> argument, that allows if rest api returns an error http status code (such as 4XX or 5XX) the whole step fails, that allows you to have a better view whether PR was created or not.</p>

